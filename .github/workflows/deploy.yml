name: build-deploy

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: self-hosted   # your self-hosted runner

    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Docker login
      - name: Docker Login
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
          echo "‚úÖ Docker login successful"

      # 3Ô∏è‚É£ Build Docker image
      - name: Build Docker image
        run: |
          IMAGE="${{ secrets.DOCKER_USERNAME }}/my-nginx:latest"
          docker build -t $IMAGE .

      # 4Ô∏è‚É£ Push Docker image
      - name: Push Docker image
        run: |
          IMAGE="${{ secrets.DOCKER_USERNAME }}/my-nginx:latest"
          docker push $IMAGE

      # 5Ô∏è‚É£ Deploy to Kubernetes
      - name: Deploy to Kubernetes
        run: |
          IMAGE="${{ secrets.DOCKER_USERNAME }}/my-nginx:latest"
          sed -i "s|image: .*|image: $IMAGE|" k8s/deployment.yaml
          kubectl apply -f k8s/

      # 6Ô∏è‚É£ Verify Deployment
      - name: Verify Deployment
        run: |
          kubectl rollout status deployment/my-nginx
          kubectl get pods -o wide
          echo "üöÄ Deployment finished successfully!"
